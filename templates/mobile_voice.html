<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Voice Agent - James</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: white;
        }
        
        .header {
            text-align: center;
            padding: 2rem 1rem;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            opacity: 0.8;
            font-size: 1.1rem;
        }
        
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }
        
        .voice-button {
            width: 150px;
            height: 150px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(145deg, #ff6b6b, #ee5a52);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 2rem 0;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .voice-button:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
        }
        
        .voice-button.recording {
            background: linear-gradient(145deg, #4ecdc4, #44a08d);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .status {
            background: rgba(255,255,255,0.1);
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            min-height: 60px;
            width: 100%;
            backdrop-filter: blur(10px);
        }
        
        .conversation {
            flex: 1;
            width: 100%;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 1rem;
            margin: 1rem 0;
            max-height: 400px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        
        .message {
            margin-bottom: 1rem;
            padding: 0.8rem;
            border-radius: 10px;
            max-width: 90%;
        }
        
        .user-message {
            background: rgba(255,255,255,0.2);
            margin-left: auto;
            text-align: right;
        }
        
        .ai-message {
            background: rgba(0,0,0,0.2);
            margin-right: auto;
        }
        
        .menu-info {
            background: rgba(255,255,255,0.1);
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            backdrop-filter: blur(10px);
        }
        
        .menu-info h3 {
            margin-bottom: 0.5rem;
            color: #ffd700;
        }
        
        .menu-item {
            padding: 0.3rem 0;
            opacity: 0.9;
        }
        
        .icon {
            width: 30px;
            height: 30px;
            margin-bottom: 0.5rem;
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .voice-button {
                width: 120px;
                height: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé§ AI Voice Agent</h1>
        <p>Talk to James - Your Restaurant Assistant</p>
    </div>
    
    <div class="main-container">
        <button id="voiceButton" class="voice-button">
            <div>üéôÔ∏è</div>
            <div>Tap to Talk</div>
        </button>
        
        <div id="status" class="status">
            Ready to listen! Tap the microphone to start talking to James.
        </div>
        
        <div id="conversation" class="conversation">
            <div class="message ai-message">
                <strong>James:</strong> Hello! Welcome to our restaurant! I'm James, your AI assistant. I can help you make reservations or take your order. How can I assist you today?
            </div>
        </div>
        
        <div class="menu-info">
            <h3>üìã Menu Available</h3>
            <div class="menu-item">ü•ü Roast Pork Egg Roll (3pcs) - $5.25</div>
            <div class="menu-item">ü•¨ Vegetable Spring Roll (3pcs) - $5.25</div>
            <div class="menu-item">üêî Chicken Egg Roll (3pcs) - $5.25</div>
            <div class="menu-item">üçó BBQ Chicken - $7.75</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io();
        const voiceButton = document.getElementById('voiceButton');
        const status = document.getElementById('status');
        const conversation = document.getElementById('conversation');
        
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let wakeWordMode = true;
        let isListeningForWakeWord = false;
        
        // Wake word detection
        const wakeWords = ['hey james', 'james', 'hello james', 'hi james', 'jarvis'];
        
        voiceButton.addEventListener('click', toggleRecording);
        
        // Start wake word detection on page load
        window.addEventListener('load', () => {
            checkMicrophonePermission();
        });
        
        async function checkMicrophonePermission() {
            try {
                // First check if browser supports microphone
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Microphone not supported in this browser');
                }
                
                // Request permission by briefly accessing microphone
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop()); // Stop immediately
                
                // If we get here, permission was granted
                startWakeWordDetection();
                
            } catch (error) {
                console.error('Microphone permission error:', error);
                handleMicrophoneError(error);
            }
        }
        
        function handleMicrophoneError(error) {
            let errorMessage = '';
            
            if (error.name === 'NotAllowedError') {
                errorMessage = 'Please allow microphone access and refresh the page';
                voiceButton.innerHTML = '<div>üé§</div><div>Allow Mic Access</div>';
                voiceButton.style.background = 'linear-gradient(145deg, #ffa726, #ff8f00)';
                voiceButton.onclick = () => window.location.reload();
            } else if (error.name === 'NotFoundError') {
                errorMessage = 'No microphone found on this device';
                voiceButton.innerHTML = '<div>üö´</div><div>No Microphone</div>';
                voiceButton.style.background = 'linear-gradient(145deg, #ff6b6b, #d63031)';
            } else {
                errorMessage = 'Microphone error: ' + error.message;
                voiceButton.innerHTML = '<div>‚ö†Ô∏è</div><div>Mic Error</div>';
                voiceButton.style.background = 'linear-gradient(145deg, #ff6b6b, #d63031)';
            }
            
            status.textContent = errorMessage;
            addMessage('system', errorMessage);
        }
        
        function startWakeWordDetection() {
            if (isListeningForWakeWord) return;
            
            wakeWordMode = true;
            voiceButton.innerHTML = '<div>üëÇ</div><div>Say "Hey James"</div>';
            status.textContent = 'Wake word mode: Say "Hey James" to activate!';
            voiceButton.style.background = 'linear-gradient(145deg, #4ecdc4, #44a08d)';
            
            // Start continuous listening for wake word
            continuousWakeWordListen();
        }
        
        async function continuousWakeWordListen() {
            if (!wakeWordMode) return;
            
            try {
                // Check if microphone is supported
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Microphone not supported in this browser');
                }
                
                isListeningForWakeWord = true;
                
                // Request microphone permission with better error handling
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                mediaRecorder = new MediaRecorder(stream, { 
                    mimeType: MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4'
                });
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        // Send for wake word detection
                        socket.emit('wake_word_check', { audio: reader.result });
                    };
                    reader.readAsDataURL(audioBlob);
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                    
                    // Continue listening for wake word if still in wake word mode
                    if (wakeWordMode) {
                        setTimeout(continuousWakeWordListen, 500);
                    }
                };
                
                mediaRecorder.start();
                
                // Record for 3 seconds then check for wake word
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                }, 3000);
                
            } catch (error) {
                console.error('Microphone error:', error);
                let errorMessage = '';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Microphone permission denied. Please allow microphone access and refresh the page.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'No microphone found. Please check your device.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage = 'Microphone not supported in this browser.';
                } else {
                    errorMessage = 'Error accessing microphone: ' + error.message;
                }
                
                status.textContent = errorMessage;
                voiceButton.innerHTML = '<div>üö´</div><div>Mic Error</div>';
                voiceButton.style.background = 'linear-gradient(145deg, #ff6b6b, #d63031)';
                isListeningForWakeWord = false;
                
                // Show instructions to user
                addMessage('system', 'Please enable microphone permission in your browser settings and refresh the page.');
            }
        }
        
        async function toggleRecording() {
            if (wakeWordMode) {
                // Manual activation instead of wake word
                activateJames();
                return;
            }
            
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }
        
        function activateJames() {
            wakeWordMode = false;
            isListeningForWakeWord = false;
            voiceButton.innerHTML = '<div>üéôÔ∏è</div><div>Tap to Talk</div>';
            voiceButton.style.background = 'linear-gradient(145deg, #ff6b6b, #ee5a52)';
            status.textContent = 'James is active! Tap the microphone to talk.';
            
            // Send activation message
            socket.emit('james_activated');
        }
        
        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }
        
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        socket.emit('audio_data', { audio: reader.result });
                    };
                    reader.readAsDataURL(audioBlob);
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                voiceButton.classList.add('recording');
                voiceButton.innerHTML = '<div>üõë</div><div>Recording...</div>';
                status.textContent = 'Listening... Tap again to stop and send to James.';
                
            } catch (error) {
                status.textContent = 'Error accessing microphone: ' + error.message;
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                voiceButton.classList.remove('recording');
                voiceButton.innerHTML = '<div>üéôÔ∏è</div><div>Tap to Talk</div>';
                status.textContent = 'Processing your message...';
            }
        }
        
        socket.on('wake_word_detected', (data) => {
            // Wake word detected, activate James
            activateJames();
            
            // Add activation message to conversation
            const aiDiv = document.createElement('div');
            aiDiv.className = 'message ai-message';
            aiDiv.innerHTML = `<strong>James:</strong> Hello! I heard you call me. How can I assist you today?`;
            conversation.appendChild(aiDiv);
            
            // Play activation audio if provided
            if (data.audio) {
                const audio = new Audio(data.audio);
                audio.play().catch(e => console.log('Audio play error:', e));
            }
            
            // Scroll to bottom
            conversation.scrollTop = conversation.scrollHeight;
        });
        
        socket.on('ai_response', (data) => {
            // Add user message
            const userDiv = document.createElement('div');
            userDiv.className = 'message user-message';
            userDiv.innerHTML = `<strong>You:</strong> ${data.transcript}`;
            conversation.appendChild(userDiv);
            
            // Add AI response
            const aiDiv = document.createElement('div');
            aiDiv.className = 'message ai-message';
            aiDiv.innerHTML = `<strong>James:</strong> ${data.response_text}`;
            conversation.appendChild(aiDiv);
            
            // Play audio response
            const audio = new Audio(data.audio);
            audio.play().catch(e => console.log('Audio play error:', e));
            
            // Scroll to bottom
            conversation.scrollTop = conversation.scrollHeight;
            
            status.textContent = 'Ready to listen! Tap the microphone to continue talking.';
            
            // Check if conversation should end (optional timeout)
            setTimeout(() => {
                if (!isRecording) {
                    // Go back to wake word mode after 30 seconds of inactivity
                    startWakeWordDetection();
                }
            }, 30000);
        });
        
        socket.on('conversation_ended', () => {
            // Go back to wake word detection mode
            startWakeWordDetection();
            
            const aiDiv = document.createElement('div');
            aiDiv.className = 'message ai-message';
            aiDiv.innerHTML = `<strong>James:</strong> Thank you for visiting! Say "Hey James" if you need me again.`;
            conversation.appendChild(aiDiv);
            conversation.scrollTop = conversation.scrollHeight;
        });
        
        socket.on('error', (data) => {
            status.textContent = 'Error: ' + data.message;
        });
        
        // Auto-scroll conversation
        const observer = new MutationObserver(() => {
            conversation.scrollTop = conversation.scrollHeight;
        });
        observer.observe(conversation, { childList: true });
    </script>
</body>
</html>
